# AI Backend Generation Assignment

## Zadání: Automatické generování webu (AI backend)

### 0) Důležitý reality check: Claude Code vs Claude API
- Vývoj: Claude Code pro pair programming.
- Produkce: Anthropic API pro kontrolu, logování, limity.

### 1) Hlavní flow: Klik "Generovat verzi" → job → worker → uloží verzi
- UI: Validace, vytvoří generation_job (queued), project.status = generating.
- Worker: Načte data, sestaví prompt, zavolá API, validuje, uloží do Storage/DB, loguje tokeny/cost, dokončí job.

### 2) Co čte z DB (Supabase Postgres)
- projects: must_include_text, rewriteable_text, sections/features, style/colors/tone, inspirations, form settings, domain, asset policy.
- contacts: název, adresa, telefon, email, rating/reviews, typy, popis.
- project_assets: allowed/blocked/must_use, metadata, storage_path.

#### Assety: Režim 1 (MVP): Nepředávat obrázky, jen manifest (názvy + captions + MUST list). Worker dosadí URL po generování.

### 3) Co ukládá zpátky
- Storage: project-versions/{project_id}/{version_id}/index.html, assets_manifest.json, source.zip, thumbnail.
- DB: project_versions, project_version_assets.

### 4) Token logging + anti-bokovky
- Tabulka ai_generation_jobs: id, project_id, user_id, status, model, prompt_hash/snapshot, tokens/cost, timestamps, error.
- Volitelné: ai_usage_ledger pro agregace.
- Budget: monthly_token_limit/cost_limit v profiles, is_generation_allowed.
- Bokovky: Server-side API klíč, logy, watermark <!-- Generated by Webomat -->.

### 5) Job queue / škálování
- MVP: DB queue + Python worker (FastAPI background loop).
- Future: Redis/Upstash.

### 6) Prompt processing
- System: Senior web designer rules (Bootstrap/Tailwind, accessibility, responsive, single-file).
- Task: Sekce struktura + obsah.
- Constraints: Must_include verbatim, rewritable paraphrase, asset policy.
- Data: Business summary, inspirations, asset manifest.
- Output: Valid HTML s <img data-asset-id="..."> placeholdery.

#### Po generování: Nahradit data-asset-id skutečnými URL.

### 7) Thumbnail generation
- Playwright screenshot (1200x630) po uložení HTML.
- Uložit jako asset kind=thumbnail, odkaz v project_versions.

### 8) Bezpečnost a přístupy (RLS)
- project_versions: Admin vždy, sales svoje, klient sdílené.
- Storage: Signed URLs nebo servisní role.

### 9) Test režim
- is_test=true: Zakázat generování nebo dummy HTML s cost=0.

### Doporučený tech stack
- Backend API: FastAPI (Python)
- Worker: Python process
- DB/Auth/Storage: Supabase
- Preview: App servírování
- Thumbnail: Playwright
- Model: Anthropic API
- Observability: DB logy + Sentry

### Nové tabulky (DB schéma)
```sql
ai_generation_jobs (
  id uuid PRIMARY KEY,
  project_id uuid REFERENCES projects(id),
  requested_by_user_id uuid REFERENCES profiles(id),
  status text CHECK (status IN ('queued','running','done','failed','cancelled')),
  model text,
  prompt_hash text,
  prompt_snapshot jsonb,
  input_tokens int,
  output_tokens int,
  total_tokens int,
  cost_usd numeric,
  started_at timestamptz,
  finished_at timestamptz,
  error_message text,
  created_at timestamptz DEFAULT now()
);

-- Doplnění profiles
ALTER TABLE profiles ADD COLUMN monthly_token_limit int DEFAULT 100000;
ALTER TABLE profiles ADD COLUMN monthly_cost_limit numeric DEFAULT 50.0;
ALTER TABLE profiles ADD COLUMN is_generation_allowed bool DEFAULT true;
```

### Subtasky
1. **DB schema**: Přidat ai_generation_jobs, upravit profiles.
2. **Worker implementation**: Python script pro job processing, API volání, uložení.
3. **Prompt building**: Funkce pro sestavení prompt z DB dat.
4. **Asset handling**: Manifest, placeholder replacement.
5. **Thumbnail gen**: Playwright integrace.
6. **DRY RUN mode**: Checkbox "Dry Run" → generuje "testovací stránka" bez API volání, cost=0, dummy HTML.
7. **Logging & budget**: Token logy, limit kontroly.
8. **Security**: RLS, signed URLs.

### DRY RUN
- Checkbox v UI "Dry Run".
- Worker: Nepovolá API, vrátí dummy HTML s kompletní "hello world" style stránkou, cost_usd=0.
- HTML obsahuje: DOCTYPE, head s meta, title "Dry run test web", stylizované tělo s gradient background, centrovný text "Dry run test web", badge "Webomat DRY RUN".
- Umožňuje testovat printscreen funkcionality a thumbnail generování bez nákladů.
- Implementováno jako endpoint POST /website/generate s parametrem dry_run=true.